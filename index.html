<!DOCTYPE html>
<html>
    <head>
        <title>COVID Tracker</title>
        <style>
            html,
            body {
                background: #222;
                font-family: apple-system, sans-serif;
                margin: 0;
                padding: 0;
                color: #eee;
                -webkit-font-smoothing: antialiased;
                box-sizing: border-box;
            }
            * {
                box-sizing: border-box;
            }
            main {
                width: 100%;
                padding: 5vw
            }
            summary {
                width: 100%;
                white-space: nowrap;
                margin-bottom: 10px;
            }
            figure {
                display: inline-block;
                padding: 0;
                margin: 0;
                padding-right: 20px;
                width: 33%;
            }
            h3 {
                font-size: 20px;
                line-height: 24px;
                padding: 0;
                margin: 0;
            }
            h3.positive {
                color: #eb4747;
            }
            h3.negative {
                color: #66cc66;
            }
            figcaption {
                font-size: 11px;
                color: #666;
            }
            section {
                display: inline-block;
                margin-bottom: 40px;
                max-width: 450px;
                min-width: 300px;
                margin-right: 20px;
            }
            hr {
                border: 0;
                border-bottom: 1px dotted #333;
                margin-bottom: 20px;
            }
            h2 {
                font-size: 20px;
                text-transform: uppercase;
                font-size: 12px;
                line-height: 24px;
                padding: 0;
                margin: 0;
                width: 100%;
                margin-bottom: 10px;
                width: 100%;
                border-bottom: 1px solid #333;
            }
            .rawData {
                height: 100px;
                width: 50%;
                overflow-y: scroll;
            }
            .rawData_Entry {
                display: flex;
                flex-wrap: nowrap;
                font-size: 0;
                line-height: 0;
                height: 24px;
                align-items: center;
            }
            time,
            p,
            b {
                font-size: 14px;
                margin-right: 15px;
                width: 50px;
            }
            time {
                color: #999;
            }
        </style>
        <meta name="viewport" id="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=0, width=device-width, viewport-fit=cover"/>
    </head>
    <body>
        <main></main>

        <script type="text/javascript">

            "use strict";
            
            var delay = 500;

            var feedList = localStorage["covidFeeds"] || [
                "Newcastle-under-Lyme",
                "Staffordshire Moorlands",
                "South Staffordshire",
                "Bolton",
                "Warwick",
            ];

            if(!Array.isArray(feedList)) {
                feedList = [];
            }

            
            feedList.forEach((feed, idx) => {
                var ltlaWrapper = document.createElement("section");
                document.body.querySelector("main").appendChild(ltlaWrapper);
                setTimeout(()=>{
                    fetch(constructURL(feed))
                        .then((response) => response.json())
                        .then((json) => {
                            addPanel(json.data, ltlaWrapper);
                        }).catch(function () {});
                }, delay * idx);
            });

            document.body.querySelector("main").appendChild(document.createElement("hr"));
            var utlaWrapper = document.createElement("section");
            document.body.querySelector("main").appendChild(utlaWrapper);

            fetch(constructURL("Staffordshire|utla"))
                .then((response) => response.json())
                .then((json) => {
                    addPanel(json.data, utlaWrapper);
                });

                var nationWrapper = document.createElement("section");
            document.body.querySelector("main").appendChild(nationWrapper);

            fetch(constructURL("England|nation"))
                .then((response) => response.json())
                .then((json) => {
                    addPanel(json.data, nationWrapper);
                });

            function addPanel(data, wrapper) {
                var title = document.createElement("h2");
                title.textContent = data[0].areaName;
                wrapper.appendChild(title);

                var summary = document.createElement("summary");

                var day1Change = document.createElement("figure");
                var day1Value = document.createElement("h3");
                day1Value.textContent = generatePercentageChange(data[0].newCasesBySpecimenDateRollingSum, data[1].newCasesBySpecimenDateRollingSum);
                if(day1Value.textContent.substr(0,1) === "+") {
                    day1Value.classList.add("positive");
                } else if(day1Value.textContent.substr(0,1) === "-") {
                    day1Value.classList.add("negative");
                }
                
                var day1Caption = document.createElement("figCaption");
                day1Caption.textContent = "from yesterday";
                day1Change.appendChild(day1Value);
                day1Change.appendChild(day1Caption);


                var day7Change = document.createElement("figure");
                var day7Value = document.createElement("h3");
                day7Value.textContent = generatePercentageChange(data[0].newCasesBySpecimenDateRollingSum, data[6].newCasesBySpecimenDateRollingSum);
                if(day7Value.textContent.substr(0,1) === "+") {
                    day7Value.classList.add("positive");
                } else if(day7Value.textContent.substr(0,1) === "-") {
                    day7Value.classList.add("negative");
                }
                
                var day7Caption = document.createElement("figCaption");
                day7Caption.textContent = "from last week";
                day7Change.appendChild(day7Value);
                day7Change.appendChild(day7Caption);


                var rateChange = document.createElement("figure");
                var rateValue = document.createElement("h3");
                rateValue.textContent = data[0].newCasesBySpecimenDateRollingRate;
                
                var rateCaption = document.createElement("figCaption");
                rateCaption.textContent = "cases per 100k";
                rateChange.appendChild(rateValue);
                rateChange.appendChild(rateCaption);

                summary.appendChild(day1Change);
                summary.appendChild(day7Change);
                summary.appendChild(rateChange);

                wrapper.appendChild(summary);

                var dataWrapper = document.createElement("div");
                dataWrapper.classList.add("rawData");
                wrapper.appendChild(dataWrapper);
                
                data.forEach((entry, idx) => {
                    var entryWrapper = document.createElement("div");
                    entryWrapper.classList.add("rawData_Entry")

                    var date = document.createElement("time");
                    date.innerHTML = formatDate(entry.date);
                    entryWrapper.appendChild(date);

                    var value = document.createElement("b");
                    value.innerHTML = entry.newCasesBySpecimenDateRollingSum;
                    entryWrapper.appendChild(value);

                    dataWrapper.appendChild(entryWrapper);
                });
            }

            function generatePercentageChange(val1, val2) {
                var percentageChange = ((val1 - val2) / val2) * 100;
                var str = percentageChange.toFixed(1) + "%";
                if(percentageChange > 0) {
                    return "+" + str;
                } else {
                    return str;
                }
            }

            function formatDate (date) {
                var splitDate = date.split("-");
                return `${splitDate[2]}/${splitDate[1]}`;
            }

            function constructURL(areaName) {
                var splitName = areaName.split("|");
                var areaType = splitName[1] || "ltla";
                
                return "https://coronavirus.data.gov.uk/api/v1/data?filters="
                    + "areaType="
                    + areaType + ";"
                    + "areaName="
                    + encodeURI(splitName[0])
                    + "&structure=%7B"
                    + "%22areaType%22:%22areaType%22,"
                    + "%22areaName%22:%22areaName%22,"
                    + "%22date%22:%22date%22,"
                    + "%22newCasesBySpecimenDateRollingSum%22:%22newCasesBySpecimenDateRollingSum%22,"
                    + "%22newCasesBySpecimenDateRollingRate%22:%22newCasesBySpecimenDateRollingRate%22" 
                    + "%7D"
                    + "&format=json";
            }

        </script>
    </body>
</html>